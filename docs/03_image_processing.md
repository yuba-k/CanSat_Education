# 画像処理実装
## 画像処理とは
画像に対して行う処理の総称である．<br>
身近な例では，スマホのカメラアプリが自動で補正をかけたり，あるいは色調を変化させたり，といったものが画像処理に含まれる．
## OpenCVとは
Pythonはライブラリが多いことで知られるが，OpenCVも数多くのライブラリの一つである．<br>
OpenCVは画像や動画像に対する様々な処理を提供している．Pythonで画像処理を行う場合の最有力候補である．<br>
## OpenCV入門
ということで，`examples/03_image_processing`直下にあるサンプルプログラムを参照しながら，実際にOpenCVで多用する機能を見ていこう．<br>
ただし，ここでは画像に対する処理のみを対象とする．
### 開発準備
残念ながらOpenCVはデフォルトでインストールされていない．<br>
次のコマンドを打ってインストールしよう．<br>
```
pip3 install opencv-python
```
なお，RaspberryPiにインストールするときは次のコマンドを利用する．<br>
```
sudo apt-get install opencv-python
```
これでサンプルプログラムを動かす準備ができた．
### 画像読込み/表示/書込み
まずは，`examples/03_image_processing/readwrite.py`を見てみよう．
```py
# readwrite.py
import cv2

filepath = ""# 画像のパスを指定
img = cv2.imread(filepath)
cv2.imshow("read",img)
cv2.waitKey(0)
cv2.imwrite("write.jpg",img)
```
このプログラムは，画像の読み込み，表示，書き込み(保存)を行うものである．<br>
`cv2.imread`によって，任意の画像を読み込める．引数には，相対パスあるいは絶対パスで，読み込みたい画像のパスを記述する．返り値に読み込んだ画像が与えられる．<br>
`cv2.imshow`は，任意の画像をディスプレイに表示するものである．第一引数にディスプレイの名前，第二引数に画像を与える．画像処理の経過を見たい際に利用できる.<br>
`cv2.imwrite`は，画像を書き込める．第一引数に保存する場所とファイル名を拡張子付きで指定し，第二引数に保存する画像を与える．<br>
<br>
基本的に画像処理の最初のステップである，処理対象の読み込みは`cv2.imread`を使い，処理終了後はログとして`cv2.imwrite`を用いて保存する．

### 色空間の変更
そもそも画像データは三次元配列で表される．
例えば，RGBであれば，1ピクセルを表すのにR(レッド)，G(グリーン)，B(ブルー)のそれぞれの強さを表すことで，様々な色を生み出している（光の加法混色）．<br>
色を三次元で表したものを色空間と呼ぶが，これにもいくつかの種類がある．<br>
色空間には以下のようなものがある．最低限，以下の二つを知っていればよい．
|画像形式|特徴|
|-|-|
|RGB|三色の混合によって色を表す|
|HSV|色相，彩度，明度によって色を表す|

<br>

**注意**：OpenCVでは，RGB色空間は**BGR**色空間として処理されます．要は赤と青が反転するので，赤色を検出しているはずなのに青色が検出されてるってときは，多くはこれが原因です．<br>
特に，複数のライブラリを用いて画像処理を行う場合には，ライブラリ間の画像の取り扱いに注意！

OpenCVでは，色空間の変更に`cv2.cvtColor`を提供している．第一引数に画像，第二引数に色空間を指定する．<br>
色空間の指定は以下の通り．
|モード|機能|逆モード|
|-|-|-|
|cv2.COLOR_BGR2HSV|BGRをHSVに変換|cv2.COLOR_HSV2BGR|
|cv2.COLOR_RGB2BGR|RGBをBGRに変換|cv2.COLOR_BGR2RGB|
|cv2.COLOR_BGR2GRAY|BGRをグレースケールに変換|-|

グレースケールとは，イメージとしては白黒写真のこと．

実際に以下のコードを実行すればグレースケール画像を確認できる（サンプルはないので各自コピーして実行してください）
```py
import cv2
filepath = "" # パスの指定
img = cv2.imread(filepath)
gray = cv2.cvtColor(img,cv2.COLOR_BGR2GRAY)
cv2.imshow("gryaimg",gray)
cv2.waitkey(0)
```

### 赤色抽出
では，いよいよ画像から赤色を抽出してみよう．<br>
まずは，色空間の変換である．デフォルトではBGR色空間であるが，これはカラーコーンを抽出するのには不適である．BGRは細かい指定ができる反面，赤色の値の定義，範囲の定義をしにくい．そこで，ここではHSV色空間を用いた赤色抽出を行う．
```py
import cv2

#変数定義
filepath = "../../data/img/" #パスの指定
filename = "200cm.jpg"
red1_low = (0, 100, 100)#H:色相/S:彩度/V:明度の順
red1_high =  (10, 255, 255)
red2_low = (170, 100, 100)
red2_high = (180, 255, 255)

img = cv2.imread(filepath+filename)
hsv = cv2.cvtColor(img,cv2.COLOR_BGR2HSV)
mask1 = cv2.inRange(hsv,red1_low,red1_high)
mask2 = cv2.inRange(hsv,red2_low,red2_high)
mask = cv2.bitwise_or(mask1, mask2)
masked = cv2.bitwise_and(img, img, mask=mask)
cv2.imwrite("result.jpg",masked)
```
適切にカラーコーンを抽出できていることが分かる．<br>
では，`filename`を`n200cm.jpg`に変更して実行しよう．すると，カラーコーン以外も抽出してしまっている．<br>
ここからは，各チーム次第．様々な画像からカラーコーンを抽出できるようにしてみよう．

### 画像から座標を得る
では，最後に，抽出したカラーコーンの座標を求めてみよう．
`examples/03_image_processing/get_target_points.py`を実行しよう．すると，`result.jpg`が生成され，カラーコーンの縁を象っていることが分かる．<br>
本アルゴリズムは，理想的にカラーコーンを抽出できていると仮定し，三頂点の座標を求めるものである．よって，例えば，`filename`を`n200cm.jpg`にして，`height`と`width`をそれぞれ`480`,`640`に書き換えて実行すると，正確にカラーコーンを象れていないことが分かる．<br>
三点の座標は，`coordinates_x`と`coordinates_y`に記憶されており，`key`を変更することで座標にアクセスできる．<br><br>
所見では複雑な処理なので，分からなければ聞いてください．

### 現アルゴリズムの問題点
以下に本アルゴリズムの問題点を列挙する．ただし，これがすべてとは限らないため，チームで考えること．

- カラーコーン以外の赤色を抽出してしまう
    - 枯れた芝生
    - ノイズに脆弱
- 関数化されておらず汎用的でない
- カラーコーンと断定できない(赤色≠カラーコーン)
- 色のみに着目しているため色の変化に脆弱